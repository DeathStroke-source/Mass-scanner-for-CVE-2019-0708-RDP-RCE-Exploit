import os
import sys
from subprocess import STDOUT, check_output
import subprocess

#This script is written to improve this PoC script
#https://github.com/zerosum0x0/CVE-2019-0708 
#rdesktop binary was taking too long to timeout so i want it to timeout quicker
#multiple ip scan was pain in the ass


#fileName = here is your iplist "/root/Desktop/rdp_ips"
#command = here is your rdesktop directory with "rdektop" included 
#/root/Desktop/tools/CVE-2019-0708/rdesktop-fork-bd6aa6acddf0ba640a49834807872f4cc0d0a773/rdesktop

verbosity = False
outFile = ""
def argParser(argv):
    if argv[1] == "-h" or argv[1] ==  "--help":
        print("Example run : python3 script.py rdesktop rdp_ip_list")
        print("Example run : python3 script.py rdesktop rdp_ip_list -o vuln_ips")
        sys.exit(1)
    if (len(argv) < 3):
        print("So small arguments entered , see -h for more information")
        sys.exit(1)
        return
    if "-v" in argv:
        global verbosity
        verbosity = True
        return
    if "-o" in argv:
        ind = argv.index('-o')
        global outFile 
        outFile = argv[ind+1]
        return
    return

argParser(sys.argv)
rdesktopDirectory = sys.argv[1]
fileName = sys.argv[2]

vulnIps = []

with open(fileName,"r") as f:
    for ip in f:
        cmd = rdesktopDirectory + " " + str(ip)
        cmd = cmd.replace("\n","")
        cmd = cmd.split(" ") #cmd has to be array
        try:
            resp = check_output(cmd,stderr = STDOUT, timeout=7) # don't go below 6 in timeout other wise you won't be able to see patched ips
            if "VULNERABLE" in str(resp):
                print(" \033[92m [*]VULNERABLE!! \033[97m" + str(ip))
                vulnIps.append(ip)
            if "patched" in str(resp):
                print(" \033[91m [*]Target is patched!! \033[97m" + str(ip))
        except subprocess.CalledProcessError:
            if (verbosity):
                print ("No output , most likely not vulnerable")
        except subprocess.TimeoutExpired:
            if (verbosity):
                print ("Client timed out.")
f.close()

if (len(outFile) != 0):
    with open(outFile,"w") as of:
        for ip in vulnIps:
            of.write(ip)
    of.close()